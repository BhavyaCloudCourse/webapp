name: Run Tests

on:
  push:
      branches: [ "main" ]
jobs:
  test:
    name: Packer Build
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        ports:
          - 3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
        env:
          MYSQL_ROOT_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          MYSQL_DATABASE: test_dba

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '20.11.0'

      - name: Install dependencies
        run: npm install
   
      - name: Create database
        run: |
          sudo /etc/init.d/mysql start
          sudo mysql -u${{ secrets.MYSQL_USER }} -p${{ secrets.MYSQL_PASSWORD }} -e 'DROP DATABASE IF EXISTS test_dba;'
          sudo mysql -u${{ secrets.MYSQL_USER }} -p${{ secrets.MYSQL_PASSWORD }} -e 'CREATE DATABASE test_dba;'
          

      - name: Run Tests    
        run: npm test
        env:
          DB_HOST: localhost
          DB_PORT: 3306
          DB_NAME: test_dba
          DB_USER: ${{ secrets.MYSQL_USER }}
          DB_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
          PORT: 8080

      - name: Authenticate with Service Account Key
        id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
         credentials_json: '${{ secrets.GCP_CREDENTIAL }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Use gcloud CLI'
        run: 'gcloud info'

      - name: Install Packer
        run: |
          wget https://releases.hashicorp.com/packer/1.7.5/packer_1.7.5_linux_amd64.zip
          unzip packer_1.7.5_linux_amd64.zip
          sudo mv packer /usr/local/bin/packer
          packer version     

      - name : Zipping all files
        run: zip -r webapp.zip .

      - name : Packer Installation
        run :  packer init .

      - name: Check Packer file formatting
        run: packer fmt gcp.pkr.hcl
        
      - name: Check Packer file validation
        run: packer validate -var 'project_id=${{ secrets.GCP_PROJECT }}' -var 'zone=${{ secrets.GCP_ZONE }}' -var 'script_path=${{ secrets.SCRIPT_PATH }}' -var 'app_file_src=${{ secrets.APP_FILE_SRC }}' -var 'app_file_dest=${{ secrets.APP_DEST_SRC }}' -var 'source_image_family=${{ secrets.SRC_IMG_FAM }}' -var 'ssh_username=${{ secrets.SSH_USER }}' -var 'image_family=${{ secrets.IMG_FAM }}' gcp.pkr.hcl
      
      - name: Buid Images
        run: packer build -var 'project_id=${{ secrets.GCP_PROJECT }}' -var 'zone=${{ secrets.GCP_ZONE }}' -var 'script_path=${{ secrets.SCRIPT_PATH }}' -var 'app_file_src=${{ secrets.APP_FILE_SRC }}' -var 'app_file_dest=${{ secrets.APP_DEST_SRC }}' -var 'source_image_family=${{ secrets.SRC_IMG_FAM }}' -var 'ssh_username=${{ secrets.SSH_USER }}' -var 'image_family=${{ secrets.IMG_FAM }}' gcp.pkr.hcl
      
      - name: Create new Instance Template version
        run: |
          current_time=$(date +'%Y%m%d%H%M%S')
          template_name="webapp-temp-${current_time}"
          gcloud compute instance-templates create $template_name \
            --project=dev-project-414723 \
            --machine-type=e2-standard-2 \
            --network-interface=subnet=webapp \
            --instance-template-region=us-east4 \
            --region=us-east4 \
            --metadata=startup-script='#!/bin/bash
              sudo cat << EOF | sudo tee /opt/csye6225/.env
              DB_HOST="10.172.186.2"
              DB_USER="webapp"
              DB_PASSWORD="5j1sLJ(mSKB1]GNa"
              DB_NAME="webapp"
              PORT="8080"
              DB_PORT="3306"
              PROJECT_ID= "dev-project-414723"
              TOPIC_NAME="verify_email"
          EOF

                  sudo systemctl restart csye6225.service
                  sudo systemctl restart google-cloud-ops-agent
                ' \
                --service-account=service-account-vm-id@dev-project-414723.iam.gserviceaccount.com \
                --scopes=https://www.googleapis.com/auth/cloud-platform \
                --tags=ssh-22,http-server-8080,allow-health-check \
                --create-disk=auto-delete=yes,boot=yes,device-name=persistent-disk-0,image-family=csye6225,kms-key=projects/dev-project-414723/locations/us-east4/keyRings/my-key-ring3/cryptoKeys/vm-cmek3,size=100,type=pd-balanced


                    

      - name: Configure managed instance group
        run: |
          gcloud compute instance-groups managed set-instance-template instance-group-webapp1 \
          --template=projects/dev-project-414723/regions/us-east4/instanceTemplates/$template_name \
          --region=us-east4

      - name: Start rolling update
        run: |
          gcloud compute instance-groups managed rolling-action start-update instance-group-webapp1 \
          --version=template=projects/dev-project-414723/regions/us-east4/instanceTemplates/$template_name \
          --region=us-east4

      - name: Monitor update progress
        run: |
          gcloud compute instance-groups managed wait-until instance-group-webapp1 \
          --version-target-reached \
          --region=us-east4